name: 'Check Learning Path Links'
on:
  workflow_dispatch:
    inputs:
      baselineTag:
        description: 'Baseline Release Tag Override'
        required: false
        type: string

  # schedule: # Run once a week.
  #   - cron: '0 0 * * 1'
  # workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  
jobs:
  check-learning-path-links:
    name: 'Check Learning Path Links'
    runs-on: ubuntu-latest

    steps:

      - name: Checkout head
        working-directory: ./head
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          ref: main
          fetch-depth: 0 # Fetch the entire repo for the below git operations
          path: head

      - name: Get current SHA
        id: get_new_sha
        run: |
          new_sha=$(git rev-parse HEAD)
          echo "new_sha=$new_sha" >> $GITHUB_ENV
          echo "Writing new_sha into GitHub Env: $new_sha"

      - name: Get previous update SHA
        id: get_sha
        working-directory: ./head
        run: |
          cd .github
          prev_sha=$(cat learning-path-sha.txt)
          echo "prev_sha=$prev_sha" >> $GITHUB_ENV
          echo "Writing prev_sha into GitHub Env: $prev_sha"
          cd ../
    
      - name: Checkout previous update
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          ref:  ${{ env.prev_sha }}
          path: prev

      - name: Get changed files
        working-directory: ./head
        run: |
          # changed_source_files=$(git diff-tree --no-commit-id --name-only -r "$prev_sha" "$GITHUB_SHA" | { grep "**.cs$" || test $? = 1; })
          changed_source_files=$(git diff-tree --no-commit-id --name-only -r "$prev_sha" "$GITHUB_SHA" | { grep "**.cs$" || test $? = 1; })
          echo "Files to validate: '${changed_source_files}'"
          echo "updated_files=$(echo ${changed_source_files})" >> $GITHUB_ENV

      - name: Check Learning Path Links
        id: check-links
        uses: kkeirstead/LearningPathFileChecks@main
        with:
          repoURLToSearch: 'https://github.com/dotnet/dotnet-monitor'
          learningPathsDirectory: 'documentation/learningPath'
          changedFilePaths: ${{ env.updated_files }}
          sourceDirectoryName: 'src'
          oldHash: ${{ env.prev_sha }}
          newHash: ${{ env.new_sha }}
          
      - name: Generate artifacts (Comment)
        working-directory: ./head
        run: |
          mkdir -p ./learning-path-review
          echo -n "${{ steps.check-links.outputs.modifiedFiles }}" > ./learning-path-review/modifiedFiles
          echo -n "${{ steps.check-links.outputs.manuallyReview }}" > ./learning-path-review/manuallyReview
          echo -n "${{ steps.check-links.outputs.suggestions }}" > ./learning-path-review/suggestions
          echo -n "[BOT] Learning Path Update" > ./learning-path-review/issue-title

      - name: Upload artifacts (Comment)
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32
        with:
          name: learning-path-review
          path: head/learning-path-review/
