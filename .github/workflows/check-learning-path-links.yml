name: 'Check Learning Path Links'
on:
  workflow_dispatch:
    inputs:
      baselineTag:
        description: 'Baseline Release Tag Override'
        required: false
        type: string

  # schedule: # Run once a week.
  #   - cron: '0 0 * * 1'
  # workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  
jobs:
  check-learning-path-links:
    name: 'Check Learning Path Links'
    runs-on: ubuntu-latest

    steps:

      - name: Checkout head
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac
        with:
          persist-credentials: false
          ref: main
          path: head

      - name: Get previous update SHA
        id: get_sha
        working-directory: ./head
        run: |
          cd .github
          prev_branch_name=$(cat learning-path-sha.txt)
          echo "prev_branch_name=$prev_branch_name" >> $GITHUB_ENV
          echo "Writing prev_branch_name into GitHub Env"
          echo "prev_sha=$(git rev-parse kkeirstead/kkeirstead/StackFrameExceptions)"
          echo "prev_sha=$prev_sha" >> $GITHUB_ENV
          echo "$prev_sha"
          echo "Writing prev_sha into GitHub Env"
          cd ../
    
      - name: Checkout previous update
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac
        with:
          persist-credentials: false
          ref:  ${{ env.prev_sha }}
          path: prev

      - name: Get changed files
        working-directory: ./head
        run: |
          # changed_source_files=$(git diff-tree --no-commit-id --name-only -r "$prev_sha" "$GITHUB_SHA" | { grep "**.cs$" || test $? = 1; })
          changed_source_files=$(git diff-tree --no-commit-id --name-only -r "$prev_sha" "$GITHUB_SHA" | { grep "**.cs$" || test $? = 1; })
          echo "Files to validate: '${changed_source_files}'"
          echo "updated_files=$(echo ${changed_source_files})" >> $GITHUB_ENV

      - name: Check Learning Path Links
        id: check-links
        uses: kkeirstead/LearningPathFileChecks@main
        with:
          repoURLToSearch: 'https://github.com/dotnet/dotnet-monitor'
          learningPathsDirectory: 'documentation/learningPath'
          paths: ${{ env.updated_files }}
          changedFilePaths: ${{ env.updated_files }}
          sourceDirectoryName: 'src'
          
      - name: Generate artifacts (Comment)
        working-directory: ./merge
        run: |
          mkdir -p ./learning-path-review
          echo -n "${{ steps.check-links.outputs.modifiedFiles }}" > ./learning-path-review/modifiedFiles
          echo -n "${{ steps.check-links.outputs.manuallyReview }}" > ./learning-path-review/manuallyReview
          echo -n "${{ steps.check-links.outputs.suggestions }}" > ./learning-path-review/suggestions

      - name: Upload artifacts (Comment)
        uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32
        with:
          name: learning-path-review
          path: merge/learning-path-review/
